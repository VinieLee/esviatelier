<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esvi Atelier - Moda y Estilo</title>
    <!-- Carga de Tailwind CSS para estilos de utilidad -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fuentes de Google Fonts: Lato para una tipografía agradable -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos base para el cuerpo de la página */
        body {
            font-family: 'Lato', sans-serif;
            background-color: #F8F7F5; /* Blanco Roto */
            color: #333333; /* Gris Carbón */
            transition: background-color 0.5s ease; /* Transición suave para cambios de color de fondo */
        }
        /* Color de acento para elementos específicos */
        .accent-color {
            background-color: #8A9A5B; /* Verde Oliva */
        }
        /* Color de texto de acento */
        .accent-color-text {
            color: #8A9A5B;
        }
        /* Color de borde de acento */
        .accent-color-border {
            border-color: #8A9A5B;
        }
        /* Oculta la barra de desplazamiento en navegadores webkit */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Oculta la barra de desplazamiento para IE y Edge */
        .no-scrollbar {
            -ms-overflow-style: none;
            /* Oculta la barra de desplazamiento para Firefox */
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <!-- Contenedor principal de la aplicación -->
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Menú Móvil (inicialmente oculto) -->
        <div id="mobile-menu" class="hidden fixed inset-0 bg-white z-50 p-6 flex flex-col items-center justify-center text-xl space-y-6">
            <!-- Botón para cerrar el menú móvil -->
            <button class="absolute top-4 right-4 text-gray-700 text-3xl" onclick="document.getElementById('mobile-menu').classList.add('hidden'); document.getElementById('mobile-menu').classList.remove('block');">&times;</button>
            <!-- Enlaces del menú móvil -->
            <a href="#" class="block hover:text-accent-color-text" onclick="showHome(); document.getElementById('mobile-menu').classList.add('hidden'); document.getElementById('mobile-menu').classList.remove('block');">Inicio</a>
            <a href="#" class="block hover:text-accent-color-text" onclick="showCatalog(); document.getElementById('mobile-menu').classList.add('hidden'); document.getElementById('mobile-menu').classList.remove('block');">Catálogo</a>
            <a href="#" class="block hover:text-accent-color-text" onclick="showAbout(); document.getElementById('mobile-menu').classList.add('hidden'); document.getElementById('mobile-menu').classList.remove('block');">Nosotros</a>
            <a href="#" class="block hover:text-accent-color-text" onclick="showContact(); document.getElementById('mobile-menu').classList.add('hidden'); document.getElementById('mobile-menu').classList.remove('block');">Contacto</a>
        </div>

        <!-- Encabezado de la página -->
        <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10">
            <!-- Logo/Título de la tienda -->
            <a href="#" onclick="showHome();" class="text-2xl font-bold accent-color-text">Esvi Atelier</a>
            <!-- Navegación principal (oculta en móvil) -->
            <nav class="hidden md:flex space-x-6">
                <a href="#" class="hover:text-accent-color-text" onclick="showHome()">Inicio</a>
                <a href="#" class="hover:text-accent-color-text" onclick="showCatalog()">Catálogo</a>
                <a href="#" class="hover:text-accent-color-text" onclick="showAbout()">Nosotros</a>
                <a href="#" class="hover:text-accent-color-text" onclick="showContact()">Contacto</a>
            </nav>
            <!-- Iconos de carrito y menú móvil -->
            <div class="flex items-center space-x-4">
                <!-- Botón de carrito de compras -->
                <button id="cart-btn" class="relative">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <!-- Contador de ítems en el carrito -->
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
                <!-- Botón de menú móvil (visible solo en móvil) -->
                <button id="mobile-menu-btn" class="md:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Contenido principal de la página -->
        <main class="flex-grow container mx-auto p-4 flex flex-col">

            <!-- Sección de Inicio -->
            <section id="home-section" class="flex-grow flex flex-col items-center justify-center text-center p-4">
                <h2 class="text-4xl md:text-6xl font-bold accent-color-text mb-6">Esvi Atelier</h2>
                <p class="text-lg md:text-xl text-gray-700 mb-8 max-w-2xl">Donde la moda se encuentra con la artesanía. Descubre prendas únicas hechas con pasión y estilo.</p>
                <button id="explore-catalog-btn" class="bg-gradient-to-r from-green-600 to-green-800 text-white px-8 py-3 rounded-full text-lg hover:from-green-700 hover:to-green-900 transition duration-300">Explorar Catálogo</button>
            </section>

            <!-- Sección de Catálogo (inicialmente oculta) -->
            <section id="catalog-section" class="hidden py-8">
                <h2 class="text-3xl font-bold text-center mb-8 accent-color-text">Nuestros Productos</h2>
                <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                    <!-- Los productos se renderizarán aquí mediante JavaScript -->
                </div>
            </section>

            <!-- Sección Sobre Nosotros (inicialmente oculta) -->
            <section id="about-section" class="hidden py-8 text-center max-w-3xl mx-auto">
                <h2 class="text-3xl font-bold mb-4 accent-color-text">Sobre Nosotros</h2>
                <p class="text-gray-700 mb-4">En Esvi Atelier, creemos que la moda debe ser una expresión de individualidad y artesanía. Cada prenda es diseñada y confeccionada con atención al detalle, utilizando materiales de alta calidad para ofrecerte durabilidad y estilo.</p>
                <p class="text-gray-700">Nuestra misión es empoderarte a través de la ropa, ofreciéndote piezas únicas que realcen tu belleza natural y te hagan sentir confiada y elegante en cualquier ocasión.</p>
            </section>

            <!-- Sección de Contacto (inicialmente oculta) -->
            <section id="contact-section" class="hidden py-8 text-center max-w-3xl mx-auto">
                <h2 class="text-3xl font-bold mb-4 accent-color-text">Contáctanos</h2>
                <p class="text-gray-700 mb-4">¿Tienes alguna pregunta o necesitas asistencia? No dudes en contactarnos. Estamos aquí para ayudarte.</p>
                <p class="text-gray-700 mb-2">Email: info@esviatelier.com</p>
                <p class="text-gray-700">Teléfono: +34 123 456 789</p>
                <p class="text-gray-700 mt-4">Síguenos en nuestras redes sociales para estar al día con nuestras últimas colecciones y noticias.</p>
            </section>

            <!-- Modal de Producto (inicialmente oculto) -->
            <div id="product-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-lg p-6 max-w-md w-full relative">
                    <!-- Botón para cerrar el modal -->
                    <button id="close-product-modal" class="absolute top-3 right-3 text-gray-700 text-2xl">&times;</button>
                    <img id="modal-product-image" src="" alt="Product Image" class="w-full h-48 object-cover rounded-md mb-4">
                    <h3 id="modal-product-name" class="text-2xl font-bold mb-2 accent-color-text"></h3>
                    <p id="modal-product-description" class="text-gray-700 mb-4"></p>
                    <p class="text-xl font-semibold mb-4">Precio: <span id="modal-product-price" class="accent-color-text"></span></p>
                    <div class="mb-4">
                        <label for="modal-product-size" class="block text-gray-700 font-semibold mb-2">Talla:</label>
                        <select id="modal-product-size" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="S">S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="modal-product-quantity" class="block text-gray-700 font-semibold mb-2">Cantidad:</label>
                        <input type="number" id="modal-product-quantity" value="1" min="1" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <button id="add-to-cart-modal-btn" class="w-full bg-accent-color text-white py-2 rounded-md hover:opacity-90 transition duration-300">Añadir al Carrito</button>
                </div>
            </div>

            <!-- Panel del Carrito (inicialmente oculto, se desliza desde la derecha) -->
            <div id="cart-panel" class="hidden fixed inset-y-0 right-0 w-80 bg-white shadow-lg p-6 z-40 flex flex-col transform translate-x-full transition-transform duration-300 ease-in-out">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold accent-color-text">Carrito de Compras</h2>
                    <!-- Botón para cerrar el panel del carrito -->
                    <button id="close-cart-btn" class="text-gray-700 text-3xl">&times;</button>
                </div>
                <div id="cart-items-container" class="flex-grow overflow-y-auto no-scrollbar mb-4">
                    <!-- Los ítems del carrito se renderizarán aquí -->
                </div>
                <div class="border-t border-gray-200 pt-4">
                    <div class="flex justify-between font-semibold text-lg mb-4">
                        <span>Total:</span>
                        <span id="cart-total" class="accent-color-text">$0.00</span>
                    </div>
                    <!-- Botón para ir al proceso de pago -->
                    <button id="checkout-btn" class="w-full bg-accent-color text-white py-3 rounded-md hover:opacity-90 transition duration-300">Pagar</button>
                </div>
            </div>

            <!-- Sección de Checkout (Proceso de Pago) (inicialmente oculta) -->
            <section id="checkout-section" class="hidden py-8 max-w-2xl mx-auto w-full">
                <h2 class="text-3xl font-bold text-center mb-8 accent-color-text">Confirmar Pedido</h2>

                <!-- Paso 1: Información de Envío -->
                <div id="checkout-step-1" class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 accent-color-text">1. Información de Envío</h3>
                    <form id="shipping-form" class="space-y-4">
                        <div>
                            <label for="client-name" class="block text-gray-700 text-sm font-bold mb-2">Nombre:</label>
                            <input type="text" id="client-name" name="clientName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div>
                            <label for="client-lastname" class="block text-gray-700 text-sm font-bold mb-2">Apellidos:</label>
                            <input type="text" id="client-lastname" name="clientLastname" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div>
                            <label for="client-dni" class="block text-gray-700 text-sm font-bold mb-2">DNI:</label>
                            <input type="text" id="client-dni" name="clientDNI" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div>
                            <label for="client-phone" class="block text-gray-700 text-sm font-bold mb-2">Celular:</label>
                            <input type="tel" id="client-phone" name="clientPhone" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div>
                            <label for="client-email" class="block text-gray-700 text-sm font-bold mb-2">Correo Electrónico:</label>
                            <input type="email" id="client-email" name="clientEmail" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div>
                            <label for="shipping-address" class="block text-gray-700 text-sm font-bold mb-2">Dirección de Envío:</label>
                            <input type="text" id="shipping-address" name="shippingAddress" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div>
                            <label for="address-reference" class="block text-gray-700 text-sm font-bold mb-2">Referencia de Dirección (ej. # depto, condominio):</label>
                            <input type="text" id="address-reference" name="addressReference" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label for="city" class="block text-gray-700 text-sm font-bold mb-2">Ciudad:</label>
                            <input type="text" id="city" name="city" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div>
                            <label for="zip-code" class="block text-gray-700 text-sm font-bold mb-2">Código Postal:</label>
                            <input type="text" id="zip-code" name="zipCode" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <button type="button" id="next-to-step-2" class="w-full bg-accent-color text-white py-2 rounded-md hover:opacity-90 transition duration-300">Siguiente</button>
                    </form>
                </div>

                <!-- Paso 2: Resumen del Pedido y Pago -->
                <div id="checkout-step-2" class="hidden bg-white p-6 rounded-lg shadow-md mt-8">
                    <h3 class="text-xl font-semibold mb-4 accent-color-text">2. Resumen del Pedido y Pago</h3>
                    <div id="checkout-summary" class="mb-4">
                        <!-- El resumen del pedido se cargará dinámicamente aquí -->
                    </div>
                    <div class="flex justify-between font-bold text-xl mb-6">
                        <span>Total a Pagar:</span>
                        <span id="checkout-total" class="accent-color-text">$0.00</span>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Método de Pago:</label>
                        <select id="payment-method" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            <option value="">Selecciona un método</option>
                            <option value="transferencia">Transferencia Bancaria</option>
                            <option value="tarjeta">Tarjeta de Crédito/Débito (próximamente)</option>
                            <option value="paypal">PayPal (próximamente)</option>
                        </select>
                    </div>
                    <!-- Detalles para transferencia bancaria (ocultos inicialmente) -->
                    <div id="transfer-details" class="bg-gray-100 p-4 rounded-md mt-4 hidden">
                        <p class="font-semibold mb-2">Datos para Transferencia Bancaria:</p>
                        <p>Banco: [Nombre de tu Banco]</p>
                        <p>Número de Cuenta: [Tu Número de Cuenta]</p>
                        <p>Beneficiario: Esvi Atelier S.L.</p>
                        <p class="text-sm text-gray-600 mt-2">Por favor, realiza la transferencia y envía el comprobante a nuestro WhatsApp para confirmar tu pedido.</p>
                    </div>
                    <div class="flex space-x-4 mt-6">
                        <!-- Botones de navegación en el checkout -->
                        <button type="button" id="back-to-step-1" class="w-1/2 bg-gray-300 text-gray-800 py-2 rounded-md hover:bg-gray-400 transition duration-300">Volver</button>
                        <button type="button" id="confirm-order-btn" class="w-1/2 bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition duration-300">Confirmar Pedido</button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Pie de página -->
        <footer class="bg-white shadow-inner p-6 text-center text-gray-600 mt-auto">
            <p>&copy; 2025 Esvi Atelier. Todos los derechos reservados.</p>
            <div class="flex justify-center space-x-4 mt-2">
                <a href="#" class="hover:text-accent-color-text">Privacidad</a>
                <a href="#" class="hover:text-accent-color-text">Términos</a>
            </div>
        </footer>
    </div>

    <script>
        // URL DE TU GOOGLE APPS SCRIPT WEB APP DESPLEGADA
        // ¡ESTA URL ES CRÍTICA PARA QUE LOS DATOS SE ENVÍEN CORRECTAMENTE!
        const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwFXMU31VVMeZMP5qs7FXVUUuy-M8a-17TJLQur9ubsBYr7G60Bo6iwQw0NyVt1JwE/exec';

        // Objeto para mantener el estado de la aplicación (productos, carrito, formularios)
        const appState = {
            products: [], // Lista de productos disponibles
            cart: [],     // Ítems en el carrito del usuario
            currentProductModal: null, // Producto actualmente visualizado en el modal
            checkoutStep: 1, // Paso actual del proceso de pago
            orderForm: { // Datos del formulario de información del cliente
                clientName: '',
                clientLastname: '',
                clientDNI: '',
                clientPhone: '',
                clientEmail: '',
                shippingAddress: '',
                addressReference: '',
                city: '',
                zipCode: '',
                paymentMethod: ''
            }
        };

        // Referencias a elementos del DOM para una manipulación más fácil
        const productList = document.getElementById('product-list');
        const productModal = document.getElementById('product-modal');
        const closeProductModalBtn = document.getElementById('close-product-modal');
        const cartBtn = document.getElementById('cart-btn');
        const closeCartBtn = document.getElementById('close-cart-btn');
        const cartPanel = document.getElementById('cart-panel');
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartTotalSpan = document.getElementById('cart-total');
        const cartCountSpan = document.getElementById('cart-count');
        const checkoutBtn = document.getElementById('checkout-btn');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const exploreCatalogBtn = document.getElementById('explore-catalog-btn');

        const homeSection = document.getElementById('home-section');
        const catalogSection = document.getElementById('catalog-section');
        const aboutSection = document.getElementById('about-section');
        const contactSection = document.getElementById('contact-section');
        const checkoutSection = document.getElementById('checkout-section');

        const checkoutStep1 = document.getElementById('checkout-step-1');
        const checkoutStep2 = document.getElementById('checkout-step-2');
        const nextToStep2Btn = document.getElementById('next-to-step-2');
        const backToStep1Btn = document.getElementById('back-to-step-1');
        const confirmOrderBtn = document.getElementById('confirm-order-btn');
        const shippingForm = document.getElementById('shipping-form');
        const checkoutSummaryDiv = document.getElementById('checkout-summary');
        const checkoutTotalSpan = document.getElementById('checkout-total');
        const paymentMethodSelect = document.getElementById('payment-method');
        const transferDetailsDiv = document.getElementById('transfer-details');

        // Datos de productos (ejemplo, en una aplicación real vendrían de una API/base de datos)
        appState.products = [
            { id: 'prod1', name: 'Vestido Floral Verano', description: 'Un vestido ligero y fresco para los días soleados, con estampado floral vibrante.', price: 49.99, imageUrl: 'https://placehold.co/300x200/8A9A5B/ffffff?text=Vestido+Floral' },
            { id: 'prod2', name: 'Blusa de Lino Elegante', description: 'Blusa de lino transpirable, perfecta para un look casual o formal.', price: 35.50, imageUrl: 'https://placehold.co/300x200/8A9A5B/ffffff?text=Blusa+Lino' },
            { id: 'prod3', name: 'Pantalón Culotte', description: 'Pantalón culotte cómodo y estilizado, ideal para cualquier ocasión.', price: 42.00, imageUrl: 'https://placehold.co/300x200/8A9A5B/ffffff?text=Pantalón+Culotte' },
            { id: 'prod4', name: 'Falda Midi Plisada', description: 'Falda midi con pliegues, un clásico elegante que nunca pasa de moda.', price: 55.00, imageUrl: 'https://placehold.co/300x200/8A9A5B/ffffff?text=Falda+Midi' },
            { id: 'prod5', name: 'Chaqueta Vaquera Clásica', description: 'Una chaqueta vaquera atemporal, imprescindible en cualquier armario.', price: 65.00, imageUrl: 'https://placehold.co/300x200/8A9A5B/ffffff?text=Chaqueta+Vaquera' },
            { id: 'prod6', name: 'Camiseta Básica Algodón', description: 'Camiseta de algodón suave, ideal para combinar con cualquier outfit.', price: 19.99, imageUrl: 'https://placehold.co/300x200/8A9A5B/ffffff?text=Camiseta+Básica' }
        ];

        /**
         * Muestra la sección de la página especificada y oculta las demás.
         * @param {string} sectionId - El ID de la sección a mostrar.
         */
        function showSection(sectionId) {
            const sections = [homeSection, catalogSection, aboutSection, contactSection, checkoutSection];
            sections.forEach(section => {
                if (section.id === sectionId) {
                    section.classList.remove('hidden');
                    section.classList.add('flex', 'flex-col'); // Asegura que ocupe el espacio disponible
                } else {
                    section.classList.add('hidden');
                    section.classList.remove('flex', 'flex-col');
                }
            });
        }

        /**
         * Muestra la sección de inicio.
         */
        function showHome() {
            showSection('home-section');
        }

        /**
         * Muestra la sección de catálogo y renderiza los productos.
         */
        function showCatalog() {
            showSection('catalog-section');
            renderProducts(); // Asegura que los productos se rendericen al mostrar el catálogo
        }

        /**
         * Muestra la sección "Sobre Nosotros".
         */
        function showAbout() {
            showSection('about-section');
        }

        /**
         * Muestra la sección de contacto.
         */
        function showContact() {
            showSection('contact-section');
        }

        /**
         * Renderiza las tarjetas de productos en la sección del catálogo.
         */
        function renderProducts() {
            productList.innerHTML = ''; // Limpia el contenido actual
            appState.products.forEach(product => {
                const productCard = `
                    <div class="group bg-white rounded-lg shadow-lg overflow-hidden transform transition-all duration-300 hover:scale-105 hover:shadow-xl cursor-pointer" data-product-id="${product.id}">
                        <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-48 object-cover">
                        <div class="p-4">
                            <h3 class="text-xl font-bold mb-2 accent-color-text">${product.name}</h3>
                            <p class="text-gray-600 text-sm mb-4 line-clamp-2">${product.description}</p>
                            <p class="text-lg font-semibold accent-color-text">$${product.price.toFixed(2)}</p>
                        </div>
                    </div>
                `;
                productList.innerHTML += productCard;
            });
        }

        /**
         * Abre el modal de detalles de un producto específico.
         * @param {string} productId - El ID del producto a mostrar.
         */
        function openProductModal(productId) {
            const product = appState.products.find(p => p.id === productId);
            if (product) {
                appState.currentProductModal = product;
                document.getElementById('modal-product-image').src = product.imageUrl;
                document.getElementById('modal-product-name').textContent = product.name;
                document.getElementById('modal-product-description').textContent = product.description;
                document.getElementById('modal-product-price').textContent = `$${product.price.toFixed(2)}`;
                document.getElementById('modal-product-quantity').value = 1; // Restablecer cantidad
                document.getElementById('modal-product-size').value = 'S'; // Restablecer talla

                productModal.classList.remove('hidden');
            }
        }

        /**
         * Cierra el modal de producto.
         */
        function closeProductModal() {
            productModal.classList.add('hidden');
            appState.currentProductModal = null;
        }

        /**
         * Añade un producto al carrito o actualiza su cantidad si ya existe.
         * @param {object} product - El objeto del producto a añadir.
         * @param {number} quantity - La cantidad a añadir.
         * @param {string} size - La talla del producto.
         */
        function addToCart(product, quantity, size) {
            const existingItemIndex = appState.cart.findIndex(item => item.id === product.id && item.size === size);

            if (existingItemIndex > -1) {
                appState.cart[existingItemIndex].quantity += quantity;
            } else {
                const newItem = {
                    itemId: Date.now(), // ID único para esta instancia del ítem en el carrito
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    imageUrl: product.imageUrl,
                    quantity: quantity,
                    size: size
                };
                appState.cart.push(newItem);
            }
            renderCart(); // Vuelve a renderizar el carrito para mostrar los cambios
        }

        /**
         * Actualiza la cantidad de un ítem específico en el carrito.
         * @param {number} itemId - El ID único del ítem en el carrito.
         * @param {number} change - El cambio en la cantidad (+1, -1).
         */
        function updateCartQuantity(itemId, change) {
            const item = appState.cart.find(item => item.itemId == itemId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    // Si la cantidad es 0 o menos, elimina el ítem del carrito
                    appState.cart = appState.cart.filter(i => i.itemId != itemId);
                }
                renderCart(); // Vuelve a renderizar el carrito
            }
        }

        /**
         * Renderiza los ítems del carrito y calcula el total.
         */
        function renderCart() {
            cartItemsContainer.innerHTML = ''; // Limpia el contenido actual
            let total = 0;

            if (appState.cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-gray-500 text-center">Tu carrito está vacío.</p>';
            } else {
                appState.cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    const cartItemHtml = `
                        <div class="flex items-center space-x-4 mb-4 border-b border-gray-100 pb-4">
                            <img src="${item.imageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md">
                            <div class="flex-grow">
                                <h4 class="font-semibold">${item.name} (Talla: ${item.size})</h4>
                                <p class="text-sm text-gray-600">$${item.price.toFixed(2)} x ${item.quantity}</p>
                                <p class="font-bold accent-color-text">$${itemTotal.toFixed(2)}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="cart-quantity-change text-gray-600 hover:text-accent-color-text" data-item-id="${item.itemId}" data-change="-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                                </button>
                                <span class="font-semibold">${item.quantity}</span>
                                <button class="cart-quantity-change text-gray-600 hover:text-accent-color-text" data-item-id="${item.itemId}" data-change="1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                </button>
                                <button class="cart-item-remove text-red-500 hover:text-red-700" data-item-id="${item.itemId}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-1 1v1H5a1 1 0 000 2h14a1 1 0 100-2h-3V3a1 1 0 00-1-1H9zm-7 3a1 1 0 011-1h16a1 1 0 110 2H3a1 1 0 01-1-1zm3 3a1 1 0 011 1v9a1 1 0 001 1h8a1 1 0 001-1V9a1 1 0 112 0v9a3 3 0 01-3 3H6a3 3 0 01-3-3V9a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>
                    `;
                    cartItemsContainer.innerHTML += cartItemHtml;
                });
            }
            cartTotalSpan.textContent = `$${total.toFixed(2)}`; // Actualiza el total del carrito
            cartCountSpan.textContent = appState.cart.reduce((sum, item) => sum + item.quantity, 0); // Actualiza el contador de ítems
        }

        /**
         * Abre el panel lateral del carrito.
         */
        function openCartPanel() {
            cartPanel.classList.remove('translate-x-full'); // Desliza el panel hacia la izquierda
            cartPanel.classList.add('translate-x-0');
            cartPanel.classList.remove('hidden'); // Asegura que esté visible
        }

        /**
         * Cierra el panel lateral del carrito.
         */
        function closeCartPanel() {
            cartPanel.classList.add('translate-x-full'); // Desliza el panel hacia la derecha
            cartPanel.classList.remove('translate-x-0');
            setTimeout(() => {
                cartPanel.classList.add('hidden'); // Oculta el panel después de la transición
            }, 300); // Espera a que termine la transición (300ms)
        }

        /**
         * Renderiza los pasos del proceso de pago (checkout).
         * @param {number} step - El número del paso a mostrar (1 o 2).
         */
        function renderCheckout(step) {
            // Si el carrito está vacío, no se puede proceder al pago
            if (appState.cart.length === 0) {
                alert('Tu carrito está vacío. Por favor, añade productos antes de proceder al pago.');
                closeCartPanel();
                showCatalog(); // Muestra el catálogo si el carrito está vacío
                return;
            }

            appState.checkoutStep = step;
            showSection('checkout-section'); // Muestra la sección de checkout
            closeCartPanel(); // Cierra el panel del carrito

            if (step === 1) {
                // Muestra el paso 1 (información de envío)
                checkoutStep1.classList.remove('hidden');
                checkoutStep2.classList.add('hidden');
                // Pre-rellena el formulario con datos guardados en appState.orderForm
                for (const key in appState.orderForm) {
                    // Convierte camelCase a kebab-case para encontrar el ID del input (ej. clientName -> client-name)
                    const inputId = key.replace(/([A-Z])/g, '-$1').toLowerCase();
                    const input = document.getElementById(inputId);
                    if (input && appState.orderForm[key]) { // Solo si el input existe y hay datos guardados
                        input.value = appState.orderForm[key];
                    }
                }
            } else if (step === 2) {
                // Valida el formulario del paso 1 antes de avanzar
                if (!shippingForm.checkValidity()) {
                    shippingForm.reportValidity(); // Muestra los mensajes de validación del navegador
                    return;
                }

                // Guarda los datos del formulario del paso 1 en appState
                const formData = new FormData(shippingForm);
                for (let [key, value] of formData.entries()) {
                    appState.orderForm[key] = value;
                }

                // Muestra el paso 2 (resumen del pedido y pago)
                checkoutStep1.classList.add('hidden');
                checkoutStep2.classList.remove('hidden');
                renderCheckoutSummary(); // Renderiza el resumen del pedido
            }
        }

        /**
         * Renderiza el resumen del pedido en el paso 2 del checkout.
         */
        function renderCheckoutSummary() {
            let summaryHtml = '<h4 class="font-bold mb-2">Productos:</h4>';
            let total = 0;
            appState.cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                summaryHtml += `<p class="text-sm text-gray-700">- ${item.name} (Talla: ${item.size}) x ${item.quantity} = $${itemTotal.toFixed(2)}</p>`;
            });
            summaryHtml += `<p class="font-bold mt-4">Información de Envío:</p>`;
            summaryHtml += `<p class="text-sm text-gray-700">Nombre: ${appState.orderForm.clientName} ${appState.orderForm.clientLastname}</p>`;
            summaryHtml += `<p class="text-sm text-gray-700">DNI: ${appState.orderForm.clientDNI}</p>`;
            summaryHtml += `<p class="text-sm text-gray-700">Celular: ${appState.orderForm.clientPhone}</p>`;
            summaryHtml += `<p class="text-sm text-gray-700">Correo: ${appState.orderForm.clientEmail}</p>`;
            summaryHtml += `<p class="text-sm text-gray-700">Dirección: ${appState.orderForm.shippingAddress}, ${appState.orderForm.city}, CP ${appState.orderForm.zipCode}</p>`;
            if (appState.orderForm.addressReference) {
                summaryHtml += `<p class="text-sm text-gray-700">Referencia: ${appState.orderForm.addressReference}</p>`;
            }

            checkoutSummaryDiv.innerHTML = summaryHtml; // Inserta el resumen en el DOM
            checkoutTotalSpan.textContent = `$${total.toFixed(2)}`; // Actualiza el total a pagar
        }

        /**
         * Envía los datos del pedido a Google Apps Script.
         */
        async function sendOrderToGoogleSheet() {
            // Asegura que se haya seleccionado un método de pago
            if (!paymentMethodSelect.value) {
                alert('Por favor, selecciona un método de pago.');
                return;
            }
            appState.orderForm.paymentMethod = paymentMethodSelect.value;

            // Prepara el objeto de datos del pedido para enviar
            const orderData = {
                timestamp: new Date().toISOString(), // Fecha y hora actual
                cart: appState.cart.map(item => ({ // Mapea el carrito a un formato más simple
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    size: item.size
                })),
                customer: appState.orderForm, // Datos del cliente del formulario
                totalAmount: appState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2) // Calcula el total
            };

            console.log('Sending order data:', orderData); // Para depuración en la consola del navegador

            try {
                // Realiza la solicitud POST al Google Apps Script
                const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        // Importante: Apps Script a menudo espera 'text/plain' para el cuerpo crudo de JSON
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify(orderData) // Convierte el objeto a una cadena JSON
                });

                const result = await response.json(); // Parsea la respuesta JSON del Apps Script
                console.log('Apps Script Response:', result); // Para depuración

                if (result.status === 'SUCCESS') {
                    alert('¡Pedido realizado con éxito! Tu número de pedido es: ' + result.orderId);
                    appState.cart = []; // Vacía el carrito
                    appState.orderForm = { // Limpia los datos del formulario de pedido
                        clientName: '', clientLastname: '', clientDNI: '', clientPhone: '',
                        clientEmail: '', shippingAddress: '', addressReference: '',
                        city: '', zipCode: '', paymentMethod: ''
                    };
                    renderCart(); // Actualiza la visualización del carrito
                    showHome(); // Vuelve a la página de inicio
                } else {
                    alert('Error al procesar el pedido: ' + result.message);
                }
            } catch (error) {
                console.error('Error sending order:', error); // Manejo de errores de red o del fetch
                alert('Hubo un problema al conectar con el servicio de pedidos. Por favor, inténtalo de nuevo.');
            }
        }


        // Oyentes de eventos del DOM
        document.addEventListener('DOMContentLoaded', () => {
            // Cuando se hace clic en "Añadir al Carrito" desde el modal de producto
            document.getElementById('add-to-cart-modal-btn').addEventListener('click', () => {
                const quantity = parseInt(document.getElementById('modal-product-quantity').value);
                const size = document.getElementById('modal-product-size').value;
                if (appState.currentProductModal && quantity > 0) {
                    addToCart(appState.currentProductModal, quantity, size);
                    closeProductModal();
                }
            });

            // Cierra el modal de producto
            closeProductModalBtn.addEventListener('click', closeProductModal);

            // Abre el modal de producto cuando se hace clic en una tarjeta de producto
            productList.addEventListener('click', (e) => {
                const card = e.target.closest('.group');
                if (card) {
                    openProductModal(card.dataset.productId);
                }
            });

            // Abre y cierra el panel del carrito
            cartBtn.addEventListener('click', openCartPanel);
            closeCartBtn.addEventListener('click', closeCartPanel);

            // Maneja clics dentro del contenedor de ítems del carrito (cambio de cantidad, eliminar)
            cartItemsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('cart-item-remove')) {
                    const itemId = e.target.dataset.itemId;
                    appState.cart = appState.cart.filter(item => item.itemId != itemId);
                    renderCart();
                } else if (e.target.classList.contains('cart-quantity-change')) {
                    const itemId = e.target.dataset.itemId;
                    const change = parseInt(e.target.dataset.change);
                    updateCartQuantity(itemId, change);
                }
            });

            // Inicia el proceso de checkout
            checkoutBtn.addEventListener('click', () => renderCheckout(1));

            // Abre/Cierra el menú móvil
            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                mobileMenu.classList.toggle('block');
            });

            // Navega al catálogo desde el botón de la página de inicio
            exploreCatalogBtn.addEventListener('click', showCatalog);

            // Navegación entre pasos del checkout
            nextToStep2Btn.addEventListener('click', () => renderCheckout(2));
            backToStep1Btn.addEventListener('click', () => renderCheckout(1));
            // ¡El botón de confirmar pedido llama a la función de envío de datos!
            confirmOrderBtn.addEventListener('click', sendOrderToGoogleSheet);

            // Muestra/Oculta los detalles de transferencia según el método de pago seleccionado
            paymentMethodSelect.addEventListener('change', (e) => {
                if (e.target.value === 'transferencia') {
                    transferDetailsDiv.classList.remove('hidden');
                } else {
                    transferDetailsDiv.classList.add('hidden');
                }
            });

            // Renderizaciones iniciales al cargar la página
            renderProducts(); // Dibuja los productos en el catálogo
            renderCart();     // Dibuja el carrito (vacío o con ítems si hubo persistencia)
            showHome();       // Muestra la página de inicio por defecto
        });
    </script>
</body>
</html>
