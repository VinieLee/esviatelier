<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esvi Atelier - Moda y Estilo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background-color: #F8F7F5; /* Blanco Roto */
            color: #333333; /* Gris Carbón */
            transition: background-color 0.5s ease; /* Transición para cambios de color de fondo */
        }
        .accent-color {
            background-color: #8A9A5B; /* Verde Oliva */
        }
        .accent-color-text {
            color: #8A9A5B;
        }
        .accent-color-border {
            border-color: #8A9A5B;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden fixed inset-0 bg-white z-50 p-6 flex flex-col items-center justify-center text-xl space-y-6">
            <button class="absolute top-4 right-4 text-gray-700 text-3xl" onclick="document.getElementById('mobile-menu').classList.add('hidden'); document.getElementById('mobile-menu').classList.remove('block');">&times;</button>
            <a href="#" class="block hover:text-accent-color-text" onclick="showHome(); document.getElementById('mobile-menu').classList.add('hidden'); document.getElementById('mobile-menu').classList.remove('block');">Inicio</a>
            <a href="#" class="block hover:text-accent-color-text" onclick="showCatalog(); document.getElementById('mobile-menu').classList.add('hidden'); document.getElementById('mobile-menu').classList.remove('block');">Catálogo</a>
            <a href="#" class="block hover:text-accent-color-text" onclick="showAbout(); document.getElementById('mobile-menu').classList.add('hidden'); document.getElementById('mobile-menu').classList.remove('block');">Nosotros</a>
            <a href="#" class="block hover:text-accent-color-text" onclick="showContact(); document.getElementById('mobile-menu').classList.add('hidden'); document.getElementById('mobile-menu').classList.remove('block');">Contacto</a>
        </div>

        <!-- Header -->
        <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10">
            <a href="#" onclick="showHome();" class="text-2xl font-bold accent-color-text">Esvi Atelier</a>
            <nav class="hidden md:flex space-x-6">
                <a href="#" class="hover:text-accent-color-text" onclick="showHome()">Inicio</a>
                <a href="#" class="hover:text-accent-color-text" onclick="showCatalog()">Catálogo</a>
                <a href="#" class="hover:text-accent-color-text" onclick="showAbout()">Nosotros</a>
                <a href="#" class="hover:text-accent-color-text" onclick="showContact()">Contacto</a>
            </nav>
            <div class="flex items-center space-x-4">
                <button id="cart-btn" class="relative">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
                <button id="mobile-menu-btn" class="md:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto p-4 flex flex-col">

            <!-- Home Section -->
            <section id="home-section" class="flex-grow flex flex-col items-center justify-center text-center p-4">
                <h2 class="text-4xl md:text-6xl font-bold accent-color-text mb-6">Esvi Atelier</h2>
                <p class="text-lg md:text-xl text-gray-700 mb-8 max-w-2xl">Donde la moda se encuentra con la artesanía. Descubre prendas únicas hechas con pasión y estilo.</p>
                <button id="explore-catalog-btn" class="bg-gradient-to-r from-green-600 to-green-800 text-white px-8 py-3 rounded-full text-lg hover:from-green-700 hover:to-green-900 transition duration-300">Explorar Catálogo</button>
            </section>

            <!-- Catalog Section -->
            <section id="catalog-section" class="hidden py-8">
                <h2 class="text-3xl font-bold text-center mb-8 accent-color-text">Nuestros Productos</h2>
                <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                    <!-- Products will be rendered here by JavaScript -->
                </div>
            </section>

            <!-- About Section -->
            <section id="about-section" class="hidden py-8 text-center max-w-3xl mx-auto">
                <h2 class="text-3xl font-bold mb-4 accent-color-text">Sobre Nosotros</h2>
                <p class="text-gray-700 mb-4">En Esvi Atelier, creemos que la moda debe ser una expresión de individualidad y artesanía. Cada prenda es diseñada y confeccionada con atención al detalle, utilizando materiales de alta calidad para ofrecerte durabilidad y estilo.</p>
                <p class="text-gray-700">Nuestra misión es empoderarte a través de la ropa, ofreciéndote piezas únicas que realcen tu belleza natural y te hagan sentir confiada y elegante en cualquier ocasión.</p>
            </section>

            <!-- Contact Section -->
            <section id="contact-section" class="hidden py-8 text-center max-w-3xl mx-auto">
                <h2 class="text-3xl font-bold mb-4 accent-color-text">Contáctanos</h2>
                <p class="text-gray-700 mb-4">¿Tienes alguna pregunta o necesitas asistencia? No dudes en contactarnos. Estamos aquí para ayudarte.</p>
                <p class="text-gray-700 mb-2">Email: info@esviatelier.com</p>
                <p class="text-gray-700">Teléfono: +34 123 456 789</p>
                <p class="text-gray-700 mt-4">Síguenos en nuestras redes sociales para estar al día con nuestras últimas colecciones y noticias.</p>
            </section>

            <!-- Product Modal -->
            <div id="product-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-lg p-6 max-w-md w-full relative">
                    <button id="close-product-modal" class="absolute top-3 right-3 text-gray-700 text-2xl">&times;</button>
                    <img id="modal-product-image" src="" alt="Product Image" class="w-full h-48 object-cover rounded-md mb-4">
                    <h3 id="modal-product-name" class="text-2xl font-bold mb-2 accent-color-text"></h3>
                    <p id="modal-product-description" class="text-gray-700 mb-4"></p>
                    <p class="text-xl font-semibold mb-4">Precio: <span id="modal-product-price" class="accent-color-text"></span></p>
                    <div class="mb-4">
                        <label for="modal-product-size" class="block text-gray-700 font-semibold mb-2">Talla:</label>
                        <select id="modal-product-size" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="S">S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="modal-product-quantity" class="block text-gray-700 font-semibold mb-2">Cantidad:</label>
                        <input type="number" id="modal-product-quantity" value="1" min="1" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <button id="add-to-cart-modal-btn" class="w-full bg-accent-color text-white py-2 rounded-md hover:opacity-90 transition duration-300">Añadir al Carrito</button>
                </div>
            </div>

            <!-- Cart Panel -->
            <div id="cart-panel" class="hidden fixed inset-y-0 right-0 w-80 bg-white shadow-lg p-6 z-40 flex flex-col transform translate-x-full transition-transform duration-300 ease-in-out">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold accent-color-text">Carrito de Compras</h2>
                    <button id="close-cart-btn" class="text-gray-700 text-3xl">&times;</button>
                </div>
                <div id="cart-items-container" class="flex-grow overflow-y-auto no-scrollbar mb-4">
                    <!-- Cart items will be rendered here -->
                </div>
                <div class="border-t border-gray-200 pt-4">
                    <div class="flex justify-between font-semibold text-lg mb-4">
                        <span>Total:</span>
                        <span id="cart-total" class="accent-color-text">$0.00</span>
                    </div>
                    <button id="checkout-btn" class="w-full bg-accent-color text-white py-3 rounded-md hover:opacity-90 transition duration-300">Pagar</button>
                </div>
            </div>

            <!-- Checkout Section -->
            <section id="checkout-section" class="hidden py-8 max-w-2xl mx-auto w-full">
                <h2 class="text-3xl font-bold text-center mb-8 accent-color-text">Confirmar Pedido</h2>

                <!-- Step 1: Shipping Information -->
                <div id="checkout-step-1" class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 accent-color-text">1. Información de Envío</h3>
                    <form id="shipping-form" class="space-y-4">
                        <div>
                            <label for="client-name" class="block text-gray-700 text-sm font-bold mb-2">Nombre:</label>
                            <input type="text" id="client-name" name="clientName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div>
                            <label for="client-lastname" class="block text-gray-700 text-sm font-bold mb-2">Apellidos:</label>
                            <input type="text" id="client-lastname" name="clientLastname" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div>
                            <label for="client-dni" class="block text-gray-700 text-sm font-bold mb-2">DNI:</label>
                            <input type="text" id="client-dni" name="clientDNI" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div>
                            <label for="client-phone" class="block text-gray-700 text-sm font-bold mb-2">Celular:</label>
                            <input type="tel" id="client-phone" name="clientPhone" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div>
                            <label for="client-email" class="block text-gray-700 text-sm font-bold mb-2">Correo Electrónico:</label>
                            <input type="email" id="client-email" name="clientEmail" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div>
                            <label for="shipping-address" class="block text-gray-700 text-sm font-bold mb-2">Dirección de Envío:</label>
                            <input type="text" id="shipping-address" name="shippingAddress" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div>
                            <label for="address-reference" class="block text-gray-700 text-sm font-bold mb-2">Referencia de Dirección (ej. # depto, condominio):</label>
                            <input type="text" id="address-reference" name="addressReference" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label for="city" class="block text-gray-700 text-sm font-bold mb-2">Ciudad:</label>
                            <input type="text" id="city" name="city" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div>
                            <label for="zip-code" class="block text-gray-700 text-sm font-bold mb-2">Código Postal:</label>
                            <input type="text" id="zip-code" name="zipCode" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <button type="button" id="next-to-step-2" class="w-full bg-accent-color text-white py-2 rounded-md hover:opacity-90 transition duration-300">Siguiente</button>
                    </form>
                </div>

                <!-- Step 2: Order Summary and Payment -->
                <div id="checkout-step-2" class="hidden bg-white p-6 rounded-lg shadow-md mt-8">
                    <h3 class="text-xl font-semibold mb-4 accent-color-text">2. Resumen del Pedido y Pago</h3>
                    <div id="checkout-summary" class="mb-4">
                        <!-- Order summary will be dynamically loaded here -->
                    </div>
                    <div class="flex justify-between font-bold text-xl mb-6">
                        <span>Total a Pagar:</span>
                        <span id="checkout-total" class="accent-color-text">$0.00</span>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Método de Pago:</label>
                        <select id="payment-method" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            <option value="">Selecciona un método</option>
                            <option value="transferencia">Transferencia Bancaria</option>
                            <option value="tarjeta">Tarjeta de Crédito/Débito (próximamente)</option>
                            <option value="paypal">PayPal (próximamente)</option>
                        </select>
                    </div>
                    <div id="transfer-details" class="bg-gray-100 p-4 rounded-md mt-4 hidden">
                        <p class="font-semibold mb-2">Datos para Transferencia Bancaria:</p>
                        <p>Banco: [Nombre de tu Banco]</p>
                        <p>Número de Cuenta: [Tu Número de Cuenta]</p>
                        <p>Beneficiario: Esvi Atelier S.L.</p>
                        <p class="text-sm text-gray-600 mt-2">Por favor, realiza la transferencia y envía el comprobante a nuestro WhatsApp para confirmar tu pedido.</p>
                    </div>
                    <div class="flex space-x-4 mt-6">
                        <button type="button" id="back-to-step-1" class="w-1/2 bg-gray-300 text-gray-800 py-2 rounded-md hover:bg-gray-400 transition duration-300">Volver</button>
                        <button type="button" id="confirm-order-btn" class="w-1/2 bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition duration-300">Confirmar Pedido</button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="bg-white shadow-inner p-6 text-center text-gray-600 mt-auto">
            <p>&copy; 2025 Esvi Atelier. Todos los derechos reservados.</p>
            <div class="flex justify-center space-x-4 mt-2">
                <a href="#" class="hover:text-accent-color-text">Privacidad</a>
                <a href="#" class="hover:text-accent-color-text">Términos</a>
            </div>
        </footer>
    </div>

    <script>
        // ¡IMPORTANTE! REEMPLAZA ESTO CON LA URL DE TU GOOGLE APPS SCRIPT WEB APP DESPLEGADA
        const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyymLBl6YBz5pu10pAqq-kueeQl5pGbW0i5Wm9cAobVHDf2MqB1kkMzk45AXQFhwP8a/exec';

        const appState = {
            products: [],
            cart: [],
            currentProductModal: null,
            checkoutStep: 1,
            orderForm: { // New object to store checkout form data
                clientName: '',
                clientLastname: '',
                clientDNI: '',
                clientPhone: '',
                clientEmail: '',
                shippingAddress: '',
                addressReference: '',
                city: '',
                zipCode: '',
                paymentMethod: ''
            }
        };

        const productList = document.getElementById('product-list');
        const productModal = document.getElementById('product-modal');
        const closeProductModalBtn = document.getElementById('close-product-modal');
        const cartBtn = document.getElementById('cart-btn');
        const closeCartBtn = document.getElementById('close-cart-btn');
        const cartPanel = document.getElementById('cart-panel');
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartTotalSpan = document.getElementById('cart-total');
        const cartCountSpan = document.getElementById('cart-count');
        const checkoutBtn = document.getElementById('checkout-btn');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const exploreCatalogBtn = document.getElementById('explore-catalog-btn');

        const homeSection = document.getElementById('home-section');
        const catalogSection = document.getElementById('catalog-section');
        const aboutSection = document.getElementById('about-section');
        const contactSection = document.getElementById('contact-section');
        const checkoutSection = document.getElementById('checkout-section');

        const checkoutStep1 = document.getElementById('checkout-step-1');
        const checkoutStep2 = document.getElementById('checkout-step-2');
        const nextToStep2Btn = document.getElementById('next-to-step-2');
        const backToStep1Btn = document.getElementById('back-to-step-1');
        const confirmOrderBtn = document.getElementById('confirm-order-btn');
        const shippingForm = document.getElementById('shipping-form');
        const checkoutSummaryDiv = document.getElementById('checkout-summary');
        const checkoutTotalSpan = document.getElementById('checkout-total');
        const paymentMethodSelect = document.getElementById('payment-method');
        const transferDetailsDiv = document.getElementById('transfer-details');

        // Dummy product data
        appState.products = [
            { id: 'prod1', name: 'Vestido Floral Verano', description: 'Un vestido ligero y fresco para los días soleados, con estampado floral vibrante.', price: 49.99, imageUrl: 'https://via.placeholder.com/300x200?text=Vestido+Floral' },
            { id: 'prod2', name: 'Blusa de Lino Elegante', description: 'Blusa de lino transpirable, perfecta para un look casual o formal.', price: 35.50, imageUrl: 'https://via.placeholder.com/300x200?text=Blusa+Lino' },
            { id: 'prod3', name: 'Pantalón Culotte', description: 'Pantalón culotte cómodo y estilizado, ideal para cualquier ocasión.', price: 42.00, imageUrl: 'https://via.placeholder.com/300x200?text=Pantalón+Culotte' },
            { id: 'prod4', name: 'Falda Midi Plisada', description: 'Falda midi con pliegues, un clásico elegante que nunca pasa de moda.', price: 55.00, imageUrl: 'https://via.placeholder.com/300x200?text=Falda+Midi' },
            { id: 'prod5', name: 'Chaqueta Vaquera Clásica', description: 'Una chaqueta vaquera atemporal, imprescindible en cualquier armario.', price: 65.00, imageUrl: 'https://via.placeholder.com/300x200?text=Chaqueta+Vaquera' },
            { id: 'prod6', name: 'Camiseta Básica Algodón', description: 'Camiseta de algodón suave, ideal para combinar con cualquier outfit.', price: 19.99, imageUrl: 'https://via.placeholder.com/300x200?text=Camiseta+Básica' }
        ];

        function showSection(sectionId) {
            const sections = [homeSection, catalogSection, aboutSection, contactSection, checkoutSection];
            sections.forEach(section => {
                if (section.id === sectionId) {
                    section.classList.remove('hidden');
                    section.classList.add('flex', 'flex-col'); // Ensure it takes full height if content allows
                } else {
                    section.classList.add('hidden');
                    section.classList.remove('flex', 'flex-col');
                }
            });
        }

        function showHome() {
            showSection('home-section');
        }

        function showCatalog() {
            showSection('catalog-section');
        }

        function showAbout() {
            showSection('about-section');
        }

        function showContact() {
            showSection('contact-section');
        }

        function renderProducts() {
            productList.innerHTML = '';
            appState.products.forEach(product => {
                const productCard = `
                    <div class="group bg-white rounded-lg shadow-lg overflow-hidden transform transition-all duration-300 hover:scale-105 hover:shadow-xl cursor-pointer" data-product-id="${product.id}">
                        <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-48 object-cover">
                        <div class="p-4">
                            <h3 class="text-xl font-bold mb-2 accent-color-text">${product.name}</h3>
                            <p class="text-gray-600 text-sm mb-4 line-clamp-2">${product.description}</p>
                            <p class="text-lg font-semibold accent-color-text">$${product.price.toFixed(2)}</p>
                        </div>
                    </div>
                `;
                productList.innerHTML += productCard;
            });
        }

        function openProductModal(productId) {
            const product = appState.products.find(p => p.id === productId);
            if (product) {
                appState.currentProductModal = product;
                document.getElementById('modal-product-image').src = product.imageUrl;
                document.getElementById('modal-product-name').textContent = product.name;
                document.getElementById('modal-product-description').textContent = product.description;
                document.getElementById('modal-product-price').textContent = `$${product.price.toFixed(2)}`;
                document.getElementById('modal-product-quantity').value = 1; // Reset quantity
                document.getElementById('modal-product-size').value = 'S'; // Reset size

                productModal.classList.remove('hidden');
            }
        }

        function closeProductModal() {
            productModal.classList.add('hidden');
            appState.currentProductModal = null;
        }

        function addToCart(product, quantity, size) {
            const existingItemIndex = appState.cart.findIndex(item => item.id === product.id && item.size === size);

            if (existingItemIndex > -1) {
                appState.cart[existingItemIndex].quantity += quantity;
            } else {
                const newItem = {
                    itemId: Date.now(), // Unique ID for cart item instance
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    imageUrl: product.imageUrl,
                    quantity: quantity,
                    size: size
                };
                appState.cart.push(newItem);
            }
            renderCart();
        }

        function updateCartQuantity(itemId, change) {
            const item = appState.cart.find(item => item.itemId == itemId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    appState.cart = appState.cart.filter(i => i.itemId != itemId);
                }
                renderCart();
            }
        }

        function renderCart() {
            cartItemsContainer.innerHTML = '';
            let total = 0;

            if (appState.cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-gray-500 text-center">Tu carrito está vacío.</p>';
            } else {
                appState.cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    const cartItemHtml = `
                        <div class="flex items-center space-x-4 mb-4 border-b border-gray-100 pb-4">
                            <img src="${item.imageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md">
                            <div class="flex-grow">
                                <h4 class="font-semibold">${item.name} (${item.size})</h4>
                                <p class="text-sm text-gray-600">$${item.price.toFixed(2)} x ${item.quantity}</p>
                                <p class="font-bold accent-color-text">$${itemTotal.toFixed(2)}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="cart-quantity-change text-gray-600 hover:text-accent-color-text" data-item-id="${item.itemId}" data-change="-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                                </button>
                                <span class="font-semibold">${item.quantity}</span>
                                <button class="cart-quantity-change text-gray-600 hover:text-accent-color-text" data-item-id="${item.itemId}" data-change="1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                </button>
                                <button class="cart-item-remove text-red-500 hover:text-red-700" data-item-id="${item.itemId}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-1 1v1H5a1 1 0 000 2h14a1 1 0 100-2h-3V3a1 1 0 00-1-1H9zm-7 3a1 1 0 011-1h16a1 1 0 110 2H3a1 1 0 01-1-1zm3 3a1 1 0 011 1v9a1 1 0 001 1h8a1 1 0 001-1V9a1 1 0 112 0v9a3 3 0 01-3 3H6a3 3 0 01-3-3V9a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>
                    `;
                    cartItemsContainer.innerHTML += cartItemHtml;
                });
            }
            cartTotalSpan.textContent = `$${total.toFixed(2)}`;
            cartCountSpan.textContent = appState.cart.reduce((sum, item) => sum + item.quantity, 0);
        }

        function openCartPanel() {
            cartPanel.classList.remove('translate-x-full');
            cartPanel.classList.add('translate-x-0');
            cartPanel.classList.remove('hidden');
        }

        function closeCartPanel() {
            cartPanel.classList.add('translate-x-full');
            cartPanel.classList.remove('translate-x-0');
            setTimeout(() => {
                cartPanel.classList.add('hidden');
            }, 300); // Allow transition to finish
        }

        function renderCheckout(step) {
            if (appState.cart.length === 0) {
                alert('Tu carrito está vacío. Por favor, añade productos antes de proceder al pago.');
                closeCartPanel();
                showCatalog();
                return;
            }

            appState.checkoutStep = step;
            showSection('checkout-section');
            closeCartPanel();

            if (step === 1) {
                checkoutStep1.classList.remove('hidden');
                checkoutStep2.classList.add('hidden');
                // Pre-fill form if data exists in appState.orderForm
                for (const key in appState.orderForm) {
                    const input = document.getElementById(key.replace(/([A-Z])/g, '-$1').toLowerCase());
                    if (input) {
                        input.value = appState.orderForm[key];
                    }
                }
            } else if (step === 2) {
                // Validate Step 1 form before proceeding
                if (!shippingForm.checkValidity()) {
                    shippingForm.reportValidity(); // Shows browser's validation messages
                    return;
                }

                // Save form data to appState
                const formData = new FormData(shippingForm);
                for (let [key, value] of formData.entries()) {
                    appState.orderForm[key] = value;
                }

                checkoutStep1.classList.add('hidden');
                checkoutStep2.classList.remove('hidden');
                renderCheckoutSummary();
            }
        }

        function renderCheckoutSummary() {
            let summaryHtml = '<h4 class="font-bold mb-2">Productos:</h4>';
            let total = 0;
            appState.cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                summaryHtml += `<p class="text-sm text-gray-700">- ${item.name} (${item.size}) x ${item.quantity} = $${itemTotal.toFixed(2)}</p>`;
            });
            summaryHtml += `<p class="font-bold mt-4">Información de Envío:</p>`;
            summaryHtml += `<p class="text-sm text-gray-700">Nombre: ${appState.orderForm.clientName} ${appState.orderForm.clientLastname}</p>`;
            summaryHtml += `<p class="text-sm text-gray-700">DNI: ${appState.orderForm.clientDNI}</p>`;
            summaryHtml += `<p class="text-sm text-gray-700">Celular: ${appState.orderForm.clientPhone}</p>`;
            summaryHtml += `<p class="text-sm text-gray-700">Correo: ${appState.orderForm.clientEmail}</p>`;
            summaryHtml += `<p class="text-sm text-gray-700">Dirección: ${appState.orderForm.shippingAddress}, ${appState.orderForm.city}, CP ${appState.orderForm.zipCode}</p>`;
            if (appState.orderForm.addressReference) {
                summaryHtml += `<p class="text-sm text-gray-700">Referencia: ${appState.orderForm.addressReference}</p>`;
            }

            checkoutSummaryDiv.innerHTML = summaryHtml;
            checkoutTotalSpan.textContent = `$${total.toFixed(2)}`;
        }

        async function sendOrderToGoogleSheet() {
            // Ensure payment method is selected
            if (!paymentMethodSelect.value) {
                alert('Por favor, selecciona un método de pago.');
                return;
            }
            appState.orderForm.paymentMethod = paymentMethodSelect.value;

            // Prepare the data payload
            const orderData = {
                timestamp: new Date().toISOString(),
                cart: appState.cart.map(item => ({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    size: item.size
                })),
                customer: appState.orderForm,
                totalAmount: appState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2)
            };

            console.log('Sending order data:', orderData); // For debugging

            try {
                const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8' // Apps Script often expects text/plain for raw body
                    },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();
                console.log('Apps Script Response:', result);

                if (result.status === 'SUCCESS') {
                    alert('¡Pedido realizado con éxito! Tu número de pedido es: ' + result.orderId);
                    appState.cart = []; // Clear cart
                    appState.orderForm = {}; // Clear form
                    renderCart(); // Update cart display
                    showHome(); // Go back to home page
                } else {
                    alert('Error al procesar el pedido: ' + result.message);
                }
            } catch (error) {
                console.error('Error sending order:', error);
                alert('Hubo un problema al conectar con el servicio de pedidos. Por favor, inténtalo de nuevo.');
            }
        }


        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('add-to-cart-modal-btn').addEventListener('click', () => {
                const quantity = parseInt(document.getElementById('modal-product-quantity').value);
                const size = document.getElementById('modal-product-size').value;
                if (appState.currentProductModal && quantity > 0) {
                    addToCart(appState.currentProductModal, quantity, size);
                    closeProductModal();
                }
            });

            closeProductModalBtn.addEventListener('click', closeProductModal);

            productList.addEventListener('click', (e) => {
                const card = e.target.closest('.group');
                if (card) {
                    openProductModal(card.dataset.productId);
                }
            });

            cartBtn.addEventListener('click', openCartPanel);
            closeCartBtn.addEventListener('click', closeCartPanel);

            cartItemsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('cart-item-remove')) {
                    const itemId = e.target.dataset.itemId;
                    appState.cart = appState.cart.filter(item => item.itemId != itemId);
                    renderCart();
                } else if (e.target.classList.contains('cart-quantity-change')) {
                    const itemId = e.target.dataset.itemId;
                    const change = parseInt(e.target.dataset.change);
                    updateCartQuantity(itemId, change);
                }
            });

            checkoutBtn.addEventListener('click', () => renderCheckout(1));

            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                mobileMenu.classList.toggle('block');
            });

            exploreCatalogBtn.addEventListener('click', showCatalog); // Botón de la portada

            nextToStep2Btn.addEventListener('click', () => renderCheckout(2));
            backToStep1Btn.addEventListener('click', () => renderCheckout(1));
            confirmOrderBtn.addEventListener('click', sendOrderToGoogleSheet); // Call the function to send data

            paymentMethodSelect.addEventListener('change', (e) => {
                if (e.target.value === 'transferencia') {
                    transferDetailsDiv.classList.remove('hidden');
                } else {
                    transferDetailsDiv.classList.add('hidden');
                }
            });

            // Initial renders
            renderProducts();
            renderCart();
            showHome(); // Mostrar la página de inicio al cargar
        });
    </script>
</body>
</html>
